WITH
  ad_data_cte AS (
    SELECT
      pjt.ad_id AS ad_id,
      UPPER(
        REGEXP_REPLACE(pjt.ad_name, ' - Copy( \\d+)?$', '')
      ) AS base_ad_name,
      SUM(pjt.spend) AS total_spent,
      SUM(pjt.order_revenue) / NULLIF(SUM(pjt.spend), 0) AS pixel_roas,
      SUM(pjt.orders_quantity) AS pixel_purchases,
      SUM(pjt.spend) / NULLIF(SUM(pjt.clicks), 0) AS cpc,
      SUM(pjt.spend) / NULLIF(SUM(pjt.orders_quantity), 0) AS pixel_cpa,
      SUM(pjt.order_revenue) / NULLIF(SUM(pjt.orders_quantity), 0) AS pixel_aov,
      SUM(pjt.spend) / NULLIF(SUM(pjt.impressions) / 1000, 0) AS cpm,
      SUM(pjt.clicks) / NULLIF(SUM(pjt.impressions), 0) AS ctr_all,
      SUM(pjt.outbound_clicks) / NULLIF(SUM(pjt.impressions), 0) AS ctr_link,
      SUM(pjt.outbound_clicks) AS total_outbound_clicks
    FROM
      pixel_joined_tvf () AS pjt
    WHERE
      pjt.event_date BETWEEN '2025-01-24' AND '2025-02-03'
      AND pjt.channel = 'facebook-ads'
      AND pjt.model = 'Triple Attribution + Meta Views'
      AND pjt.campaign_name ilike '%%'
    GROUP BY
      pjt.ad_id,
      base_ad_name
  )
SELECT
  ad.base_ad_name AS ad_name,
  SUM(ad.total_spent) AS spent,
  SUM(ad.pixel_roas * ad.total_spent) / SUM(ad.total_spent) AS roas,
  SUM(ad.pixel_purchases) AS purchases,
  SUM(ad.total_spent) / NULLIF(SUM(ad.total_outbound_clicks), 0) AS cost_per_link_click,
  SUM(ad.cpc * ad.total_spent) / SUM(ad.total_spent) AS cpc,
  SUM(ad.pixel_cpa * ad.pixel_purchases) / NULLIF(SUM(ad.pixel_purchases), 0) AS cpa,
  SUM(ad.pixel_aov * ad.pixel_purchases) / NULLIF(SUM(ad.pixel_purchases), 0) AS aov,
  SUM(ad.cpm * ad.total_spent) / SUM(ad.total_spent) AS cpm,
  SUM(ad.ctr_all * ad.total_spent) / SUM(ad.total_spent) AS ctr_all,
  SUM(ad.ctr_link * ad.total_spent) / SUM(ad.total_spent) AS ctr_link
FROM
  ad_data_cte AS ad
GROUP BY
  ad.base_ad_name
ORDER BY
  spent DESC
