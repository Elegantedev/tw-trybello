WITH
  ad_data_cte AS (
    SELECT
      pjt.campaign_name AS campaign_name,
      pjt.adset_name AS adset_name,
      pjt.channel AS channel,
      SUM(pjt.spend) AS total_spend,
      SUM(pjt.order_revenue) AS total_revenue,
      SUM(pjt.orders_quantity) AS total_orders,
      SUM(pjt.clicks) AS total_clicks,
      SUM(pjt.impressions) AS total_impressions,
      SUM(pjt.outbound_clicks) AS total_outbound_clicks,
      pjt.adset_status AS adset_status
    FROM
      pixel_joined_tvf () AS pjt
    WHERE
      pjt.channel = 'facebook-ads'
      AND pjt.adset_status = 'ACTIVE'
      AND pjt.adset_status = 'ACTIVE'
      AND pjt.campaign_status = 'ACTIVE'
      AND pjt.event_date BETWEEN '2025-04-06' AND '2025-04-09'
      AND pjt.model = 'Triple Attribution'
      AND pjt.campaign_name ilike '%scale%'
    GROUP BY
      pjt.campaign_name,
      pjt.adset_name,
      pjt.channel,
      pjt.adset_status
  )
SELECT
  ad_data_cte.campaign_name AS campaign_name,
  ad_data_cte.adset_name AS adset_name,
  CASE
    -- üî¥ High ROAS but very high CPA (bad efficiency)
    WHEN (
      ad_data_cte.total_revenue / nullIf(ad_data_cte.total_spend, 0)
    ) > 1.5
    AND (
      ad_data_cte.total_spend / nullIf(ad_data_cte.total_orders, 0)
    ) > 80 THEN '‚õîÔ∏è'

    -- üöÄ High performance / scale potential
    WHEN (
      ad_data_cte.total_revenue / nullIf(ad_data_cte.total_spend, 0)
    ) > 1.4
    AND (
      ad_data_cte.total_spend / nullIf(ad_data_cte.total_orders, 0)
    ) < 75 THEN 'üöÄ'

    -- ‚òëÔ∏è Good performance (kept)
    WHEN ad_data_cte.total_spend > 100
    AND (
      ad_data_cte.total_revenue / nullIf(ad_data_cte.total_spend, 0)
    ) < 1.5
    AND (
      ad_data_cte.total_revenue / nullIf(ad_data_cte.total_spend, 0)
    ) >= 1.3
    AND (
      ad_data_cte.total_spend / nullIf(ad_data_cte.total_orders, 0)
    ) < 76 THEN '‚òëÔ∏è'

    -- üî¥ Spend is between $42‚Äì$99 and orders = 0
    WHEN ad_data_cte.total_spend BETWEEN 42 AND 99
    AND ad_data_cte.total_orders = 0 THEN '‚õîÔ∏è'

-- ‚õîÔ∏è Rule A: Over $100, but not enough purchases
WHEN ad_data_cte.total_spend > 100
AND ad_data_cte.total_orders < 2 THEN '‚õîÔ∏è'

-- ‚õîÔ∏è Rule B: Over $100, enough purchases maybe, but bad ROAS
WHEN ad_data_cte.total_spend > 100
AND (
  ad_data_cte.total_revenue / nullIf(ad_data_cte.total_spend, 0)
) < 1.2 THEN '‚õîÔ∏è'
    -- üî¥ Spend > $150 and orders < 3
    WHEN ad_data_cte.total_spend > 150
    AND ad_data_cte.total_orders < 3 THEN '‚õîÔ∏è'

    -- ‚öìÔ∏è Low spend, expensive CPC (CPC ALL > 1.49)
    WHEN ad_data_cte.total_spend BETWEEN 0 AND 45
    AND ad_data_cte.total_orders = 0
    AND (
      ad_data_cte.total_spend / nullIf(ad_data_cte.total_clicks, 0)
    ) > 1.49 THEN '‚öìÔ∏è'

    -- ‚úÖ Everything else
    ELSE '‚úÖ'
  END AS condition_indicator,

  ad_data_cte.total_spend AS spend,
  ad_data_cte.total_revenue / nullIf(ad_data_cte.total_spend, 0) AS pixel_roas,
  ad_data_cte.total_orders AS orders_quantity,
  ad_data_cte.total_spend / nullIf(ad_data_cte.total_outbound_clicks, 0) AS outbound_cpc,
  ad_data_cte.total_spend / nullIf(ad_data_cte.total_clicks, 0) AS cpc,
  ad_data_cte.total_spend / nullIf(ad_data_cte.total_orders, 0) AS pixel_cpa,
  ad_data_cte.total_revenue / nullIf(ad_data_cte.total_orders, 0) AS pixel_aov,
  (
    ad_data_cte.total_spend / nullIf(ad_data_cte.total_impressions, 0)
  ) * 1000 AS cpm,
  ad_data_cte.adset_status AS adset_status,
  ROW_NUMBER() OVER (
    ORDER BY
      ad_data_cte.total_spend DESC
  ) AS global_rank
FROM
  ad_data_cte
ORDER BY
  global_rank
