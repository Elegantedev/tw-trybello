WITH
  ad_data_cte AS (
    SELECT
      pjt.campaign_name AS campaign_name_alias,
      pjt.adset_name AS adset_name_alias,
      pjt.ad_name AS ad_name_alias,
      SUM(pjt.spend) AS total_spend_alias,
      SUM(pjt.order_revenue) AS total_revenue_alias,
      SUM(pjt.orders_quantity) AS total_orders_alias,
      SUM(pjt.clicks) AS total_clicks_alias,
      SUM(pjt.impressions) AS total_impressions_alias,
      SUM(pjt.outbound_clicks) AS total_outbound_clicks_alias,
      pjt.ad_status AS ad_status_alias
    FROM
      pixel_joined_tvf () AS pjt
    WHERE
      pjt.channel = 'facebook-ads'
      AND pjt.ad_status = 'ACTIVE'
      AND pjt.campaign_status = 'ACTIVE'
      AND pjt.event_date BETWEEN (current_date() - 3) AND current_date()
      AND pjt.model = 'Triple Attribution + Meta Views'
      AND (
        pjt.campaign_name ILIKE '%%'
        OR pjt.campaign_name ILIKE '%%'
      )
    GROUP BY
      pjt.campaign_name,
      pjt.adset_name,
      pjt.ad_name,
      pjt.ad_status
  )
SELECT
  CONCAT(
    formatDateTime (current_date() - 3, '%m/%d/%y'),
    ' - ',
    formatDateTime (current_date(), '%m/%d/%y')
  ) AS DATE,
  ad_data_cte.campaign_name_alias AS campaign_name,
  ad_data_cte.adset_name_alias AS adset_name,
  ad_data_cte.ad_name_alias AS ad_name,
  CASE
    WHEN ad_data_cte.total_spend_alias BETWEEN 0 AND 49
    AND (
      ad_data_cte.total_spend_alias / nullIf(ad_data_cte.total_outbound_clicks_alias, 0)
    ) > 2.4 THEN 'âš“ï¸'
    WHEN (
      ad_data_cte.total_revenue_alias / nullIf(ad_data_cte.total_spend_alias, 0)
    ) > 1.4
    AND (
      ad_data_cte.total_spend_alias / nullIf(ad_data_cte.total_orders_alias, 0)
    ) < 80 THEN 'ðŸš€'
    WHEN ad_data_cte.total_spend_alias > 100
    AND (
      ad_data_cte.total_revenue_alias / nullIf(ad_data_cte.total_spend_alias, 0)
    ) < 1.4
    AND (
      ad_data_cte.total_spend_alias / nullIf(ad_data_cte.total_orders_alias, 0)
    ) < 80 THEN 'ðŸŸ£'
    WHEN (
      ad_data_cte.total_spend_alias BETWEEN 50 AND 99
      AND ad_data_cte.total_orders_alias = 0
    )
    OR (
      ad_data_cte.total_spend_alias > 100
      AND (
        ad_data_cte.total_revenue_alias / nullIf(ad_data_cte.total_spend_alias, 0)
      ) < 1.4
    ) THEN 'ðŸ›‘'
    ELSE 'ðŸŸ¢'
  END AS INFO,
  ad_data_cte.total_spend_alias AS spend,
  ad_data_cte.total_revenue_alias / nullIf(ad_data_cte.total_spend_alias, 0) AS pixel_roas,
  ad_data_cte.total_orders_alias AS orders_quantity,
  ad_data_cte.total_spend_alias / nullIf(ad_data_cte.total_outbound_clicks_alias, 0) AS outbound_cpc,
  ad_data_cte.total_spend_alias / nullIf(ad_data_cte.total_clicks_alias, 0) AS cpc,
  ad_data_cte.total_spend_alias / nullIf(ad_data_cte.total_orders_alias, 0) AS pixel_cpa,
  ad_data_cte.total_revenue_alias / nullIf(ad_data_cte.total_orders_alias, 0) AS pixel_aov,
  (
    ad_data_cte.total_spend_alias / nullIf(ad_data_cte.total_impressions_alias, 0)
  ) * 1000 AS cpm,
  ad_data_cte.ad_status_alias AS ad_status,
  ROW_NUMBER() OVER (
    ORDER BY
      ad_data_cte.total_spend_alias DESC
  ) AS global_rank
FROM
  ad_data_cte
ORDER BY
  global_rank
